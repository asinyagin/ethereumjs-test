var async = require('async');
var VM = require('ethereumjs-vm');
var Account = require('ethereumjs-account');
var Transaction = require('ethereumjs-tx');
var Trie = require('merkle-patricia-tree');
var SHA3Hash = require('sha3').SHA3Hash;

var accountAddress = 'cd2a3d9f938e13cd947ec05abc7fe734df8dd826';
var accountKey = 'cow';

var code = '6060604052604051604080611a898339016040526060805190602001805190602001505b805b825b6000600073cd2a3d9f938e13cd947ec05abc7fe734df8dd826826000815481101561000257906000526020600020900160006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555073cd2a3d9f938e13cd947ec05abc7fe734df8dd827826001815481101561000257906000526020600020900160006101000a81548173ffffffffffffffffffffffffffffffffffffffff0219169083021790555073cd2a3d9f938e13cd947ec05abc7fe734df8dd828826002815481101561000257906000526020600020900160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055507f48657265000000000000000000000000000000000000000000000000000000006040518082815260200191505060405180910390a060018254016001600050819055503373ffffffffffffffffffffffffffffffffffffffff16600260005060016101008110156100025790900160005081905550600161010260005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005081905550600090505b81548110156102c7578181815481101561000257906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1660026000508260020161010081101561000257909001600050819055508060020161010260005060008484815481101561000257906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050819055505b80600101905080506101d8565b826000600050819055505b50505080610105600050819055506102e8610305565b610107600050819055505b505b5050611771806103186000396000f35b60006201518042049050610314565b905600606060405236156100d7576000357c010000000000000000000000000000000000000000000000000000000090048063173825d91461013f5780632f54bf6e146101525780634123cb6b146101795780635c52c2f51461019a5780637065cb48146101a7578063746c9171146101ba578063797af627146101db578063b20d30a914610202578063b61d27f614610215578063b75c7dc614610253578063ba51a6df14610266578063c2cf732614610279578063cbf0b0c0146102a6578063f00d4b5d146102b9578063f1736d86146102d2576100d7565b61013d5b600034111561013a577fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c3334604051808373ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a15b5b565b005b6101506004803590602001506106dc565b005b6101636004803590602001506108ab565b6040518082815260200191505060405180910390f35b610184600450610997565b6040518082815260200191505060405180910390f35b6101a56004506109dd565b005b6101b8600480359060200150610590565b005b6101c560045061098e565b6040518082815260200191505060405180910390f35b6101ec600480359060200150610daf565b6040518082815260200191505060405180910390f35b6102136004803590602001506109a0565b005b61023d6004803590602001803590602001803590602001906004018035906020019150610a6e565b6040518082815260200191505060405180910390f35b6102646004803590602001506102f3565b005b61027760048035906020015061081d565b005b6102906004803590602001803590602001506108ed565b6040518082815260200191505060405180910390f35b6102b7600480359060200150610a24565b005b6102d06004803590602001803590602001506103f5565b005b6102dd600450610a1a565b6040518082815260200191505060405180910390f35b60006000600061010260005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050549250600083141561033a576103ef565b8260020a91506101036000506000858152602001908152602001600020600050905060008282600101600050541611156103ee578060000160008181505480929190600101919050555081816001016000828282505403925050819055507fc7fb647e59b18047309aa15aad418e5d7ca96d173ad704f1031a2c3d7591734b3385604051808373ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a15b5b50505050565b600060003660405180838380828437820191505092505050604051809103902061041e816110f1565b156105895761042c836108ab565b15610437575061058b565b61010260005060008573ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000505491506000821415610479575061058b565b610481611580565b8273ffffffffffffffffffffffffffffffffffffffff166002600050836101008110156100025790900160005081905550600061010260005060008673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050819055508161010260005060008573ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050819055507fb532073b38c83145e3e5135377a08bf9aab55bc0fd7c1179cd4fb995d2a5159c8484604051808373ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1681526020019250505060405180910390a15b505b505050565b6000366040518083838082843782019150509250505060405180910390206105b7816110f1565b156106d7576105c5826108ab565b156105d057506106d9565b6105d8611580565b60fa6001600050541015156105f0576105ef611351565b5b60fa60016000505410151561060557506106d9565b60016000818150548092919060010191905055508173ffffffffffffffffffffffffffffffffffffffff166002600050600160005054610100811015610002579090016000508190555060016000505461010260005060008473ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050819055507f994a936646fe87ffe4f1e469d3d6aa417d6b855598397f323de5b449f765f0c382604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a15b505b50565b6000600036604051808383808284378201915050925050506040518091039020610705816110f1565b156108175761010260005060008473ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050549150600082141561074c5750610819565b60016001600050540360006000505411156107675750610819565b60006002600050836101008110156100025790900160005081905550600061010260005060008573ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050819055506107c1611580565b6107c9611351565b7f58619076adf5bb0943d100ef88d52d7c3fd691b19d3a9071b555b651fbf418da83604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a15b505b5050565b600036604051808383808284378201915050925050506040518091039020610844816110f1565b156108a65760016000505482111561085c57506108a8565b8160006000508190555061086e611580565b7facbdb084c721332ac59f9b8e392196c9eb0e4932862da8eb9beaf0dad4f550da826040518082815260200191505060405180910390a15b505b50565b6000600061010260005060008473ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050541190506108e8565b919050565b60006000600060006101036000506000878152602001908152602001600020600050925061010260005060008673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005054915060008214156109565760009350610985565b8160020a9050600081846001016000505416141561097b576000935061098556610984565b60019350610985565b5b50505092915050565b60006000505481565b60016000505481565b6000366040518083838082843782019150509250505060405180910390206109c7816110f1565b156109d85781610105600050819055505b505b50565b600036604051808383808284378201915050925050506040518091039020610a04816110f1565b15610a16576000610106600050819055505b505b565b6101056000505481565b600036604051808383808284378201915050925050506040518091039020610a4b816110f1565b15610a69578173ffffffffffffffffffffffffffffffffffffffff16ff5b505b50565b6000610a79336108ab565b15610da657610a87846114e0565b15610b70577f92ca3a80853e6663fa31fa10b99225f18d4902939b4c53a9caae9043f6efd0043385878686604051808673ffffffffffffffffffffffffffffffffffffffff1681526020018581526020018473ffffffffffffffffffffffffffffffffffffffff1681526020018060200182810382528484828181526020019250808284378201915050965050505050505060405180910390a18473ffffffffffffffffffffffffffffffffffffffff168484846040518083838082843782019150509250505060006040518083038185876185025a03f1925050505060006001029050610da7565b600036436040518084848082843782019150508281526020019350505050604051809103902090508050610ba381610daf565b158015610c0357506000610108600050600083815260200190815260200160002060005060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b15610da55784610108600050600083815260200190815260200160002060005060000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055508361010860005060008381526020019081526020016000206000506001016000508190555082826101086000506000848152602001908152602001600020600050600201600050919082805482825590600052602060002090601f01602090048101928215610cda579182015b82811115610cd9578235826000505591602001919060010190610cbb565b5b509050610d059190610ce7565b80821115610d015760008181506000905550600101610ce7565b5090565b50507f1733cbb53659d713b79580f79f3f9ff215f78a7c7aa45890f3b89fc5cddfbf32813386888787604051808781526020018673ffffffffffffffffffffffffffffffffffffffff1681526020018581526020018473ffffffffffffffffffffffffffffffffffffffff168152602001806020018281038252848482818152602001925080828437820191505097505050505050505060405180910390a15b5b5b949350505050565b600081610dbb816110f1565b156110ea576000610108600050600085815260200190815260200160002060005060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415156110e957610108600050600084815260200190815260200160002060005060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166101086000506000858152602001908152602001600020600050600101600050546101086000506000868152602001908152602001600020600050600201600050604051808280548015610eea57820191906000526020600020905b815481529060010190602001808311610ecd57829003601f168201915b505091505060006040518083038185876185025a03f192505050507fe7c957c06e9a662c1a6c77366179f5b702b97651dc28eee7d5bf1dff6e40bb4a3384610108600050600087815260200190815260200160002060005060010160005054610108600050600088815260200190815260200160002060005060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166101086000506000898152602001908152602001600020600050600201600050604051808673ffffffffffffffffffffffffffffffffffffffff1681526020018581526020018481526020018373ffffffffffffffffffffffffffffffffffffffff16815260200180602001828103825283818154815260200191508054801561103657820191906000526020600020905b81548152906001019060200180831161101957829003601f168201915b5050965050505050505060405180910390a1610108600050600084815260200190815260200160002060006000820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000506000905560028201600050805460008255601f0160209004906000526020600020908101906110dc91906110be565b808211156110d857600081815060009055506001016110be565b5090565b50505060019150506110ec565b5b505b919050565b600060006000600061010260005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050549250600083141561113a57611349565b6101036000506000868152602001908152602001600020600050915060008260000160005054141561121257600060005054826000016000508190555060008260010160005081905550610104600050805480919060010190908154818355818115116111d9578183600052602060002091820191016111d891906111ba565b808211156111d457600081815060009055506001016111ba565b5090565b5b50505082600201600050819055508461010460005083600201600050548154811015610002579060005260206000209001600050819055505b8260020a90506000818360010160005054161415611348577fe1c52dc63b719ade82e8bea94cc41a0d5d28e4aaf536adb5e9cccc9ff8c1aeda3386604051808373ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a16001826000016000505411151561131b576101046000506101036000506000878152602001908152602001600020600050600201600050548154811015610002579060005260206000209001600050600090556101036000506000868152602001908152602001600020600060008201600050600090556001820160005060009055600282016000506000905550506001935061134956611347565b816000016000818150548092919060019003919050555080826001016000828282505417925050819055505b5b5b505050919050565b6000600190505b6001600050548110156114dc575b6001600050548110801561139157506000600260005082610100811015610002579090016000505414155b156113a3578080600101915050611366565b5b60016001600050541180156113d45750600060026000506001600050546101008110156100025790900160005054145b156113f3576001600081815054809291906001900391905055506113a4565b60016000505481108015611423575060006002600050600160005054610100811015610002579090016000505414155b8015611445575060006002600050826101008110156100025790900160005054145b156114d75760026000506001600050546101008110156100025790900160005054600260005082610100811015610002579090016000508190555080610102600050600060026000508461010081101561000257909001600050548152602001908152602001600020600050819055506000600260005060016000505461010081101561000257909001600050819055505b611358565b5b50565b60006114eb336108ab565b1561157a57610107600050546114ff61175f565b11156115245760006101066000508190555061151961175f565b610107600050819055505b610106600050548261010660005054011015801561155057506101056000505482610106600050540111155b1561157157816101066000828282505401925050819055506001905061157b565b6000905061157b565b5b919050565b60006000610104600050549150600090505b8181101561165d57610108600050600061010460005083815481101561000257906000526020600020900160005054815260200190815260200160002060006000820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000506000905560028201600050805460008255601f01602090049060005260206000209081019061164c919061162e565b80821115611648576000818150600090555060010161162e565b5090565b5050505b8060010190508050611592565b61166561166a565b5b5050565b60006000610104600050549150600090505b818110156117185760006001026101046000508281548110156100025790600052602060002090016000505414151561170a576101036000506000610104600050838154811015610002579060005260206000209001600050548152602001908152602001600020600060008201600050600090556001820160005060009055600282016000506000905550505b5b806001019050805061167c565b61010460005080546000825590600052602060002090810190611759919061173b565b80821115611755576000818150600090555060010161173b565b5090565b505b5050565b6000620151804204905061176e565b905600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002';
code = new Buffer(code, 'hex');

var vm = new VM(new Trie());

async.series([
  createAccount,
  runTx,
  printAccounts
], function(err) {
  if (err) console.error(err);
});

function createAccount(cb) {
  account = new Account();
  account.balance = 'f00000000000000001';
  vm.trie.put(new Buffer(accountAddress, 'hex'), account.serialize(), cb);
}

function runTx(cb) {
  var tx = new Transaction({
    data: code,
    gasLimit: 3000000,
    gasPrice: 1
  });
  tx.sign(new Buffer(sha3(accountKey), 'hex'));
  vm.runTx({ tx: tx }, cb);
}

function printAccounts(cb) {
  var stream = vm.trie.createReadStream();
  stream.on('data', function(data) {
    console.log('address: ' + data.key.toString('hex'));
    console.log('data: ' + data.value.toString('hex'));
  });
  stream.on('end', cb);
}

function sha3(str) {
  var sha = new SHA3Hash(256);
  sha.update(str);
  return sha.digest('hex');
}
